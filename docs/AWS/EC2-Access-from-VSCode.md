素晴らしいです！インターネットゲートウェイが原因でしたね。この経験を踏まえて、より実践的で確実な手順をまとめ直します。

# AWS EC2 + VS Code リモート開発環境構築手順（完全版）

## 0. 事前確認：デフォルト VPC の存在確認

### 【重要】最初に VPC 設定を確認

1. **VPC** サービスに移動
2. **VPC** 一覧で「**デフォルト VPC: はい**」の VPC があるか確認
3. **ない場合**: **アクション** → **デフォルト VPC を作成**

## 1. AWS キーペアの作成

### 手順

1. AWS マネジメントコンソールにログイン
2. **EC2** サービスに移動
3. 左メニューから「**キーペア**」を選択
4. 「**キーペアを作成**」をクリック
5. 設定項目：
   - **名前**: `my-ec2-key`（任意の名前）
   - **キーペアのタイプ**: RSA
   - **プライベートキーファイル形式**: .pem
6. 「**キーペアを作成**」をクリック
7. **重要**: ダウンロードされる `.pem` ファイルを `~/.ssh/` フォルダに保存

## 2. セキュリティグループの作成

### 手順

1. EC2 ダッシュボードで「**セキュリティグループ**」を選択
2. 「**セキュリティグループを作成**」をクリック
3. 基本設定：
   - **セキュリティグループ名**: `my-dev-sg`
   - **説明**: `Development environment security group`
   - **VPC**: **デフォルト VPC** を選択（重要！）
4. インバウンドルール：
   - **タイプ**: SSH
   - **プロトコル**: TCP
   - **ポート範囲**: 22
   - **ソース**: マイ IP（自分の IP アドレスが自動設定される）
5. 「**セキュリティグループを作成**」をクリック

## 3. EC2 インスタンスの作成

### 手順

1. EC2 ダッシュボードで「**インスタンス**」を選択
2. 「**インスタンスを起動**」をクリック
3. **名前とタグ**:
   - **名前**: `my-development-server`
4. **アプリケーションおよび OS イメージ**:
   - **Amazon Linux 2023 AMI** を選択（推奨）
5. **インスタンスタイプ**:
   - `t2.micro`（無料利用枠対象）または `t3.micro`
6. **キーペア**:
   - 先ほど作成した `my-ec2-key` を選択
7. **ネットワーク設定** → **編集**:
   - **VPC**: **デフォルト VPC** を選択（重要！）
   - **サブネット**: **デフォルトサブネット** を選択
   - **パブリック IP の自動割り当て**: **有効**
   - **セキュリティグループ**: 「既存のセキュリティグループを選択」→ `my-dev-sg`
8. **ストレージを設定**:
   - **サイズ**: 8 GiB（デフォルト、無料利用枠内）
   - **タイプ**: gp3
9. 「**インスタンスを起動**」をクリック

## 4. 【重要】ネットワーク設定の確認

### インスタンス作成後の確認作業

1. **EC2 ダッシュボード** → **インスタンス** → 対象インスタンスを選択
2. **インスタンスの状態**: `running`
3. **ステータスチェック**: `2/2 checks passed`
4. パブリック IP アドレスをメモ（例: `54.199.61.34`）

### VPC とインターネットゲートウェイの確認

1. **VPC** サービスに移動
2. **インターネットゲートウェイ** をクリック
3. **状態**が `アタッチ済み` で、インスタンスの VPC に接続されているか確認

### 【問題がある場合】インターネットゲートウェイの作成・接続

もしインターネットゲートウェイが**存在しない**または**未接続**の場合：

#### インターネットゲートウェイの作成

1. **VPC** → **インターネットゲートウェイ**
2. **インターネットゲートウェイを作成**
3. **名前**: `my-igw`
4. **作成**をクリック

#### VPC へのアタッチ

1. 作成したインターネットゲートウェイを選択
2. **アクション** → **VPC にアタッチ**
3. **VPC**: インスタンスの VPC を選択
4. **インターネットゲートウェイをアタッチ**

#### ルートテーブルの設定

1. **VPC** → **ルートテーブル**
2. インスタンスの VPC に関連するルートテーブルを選択
3. **ルート**タブ → **ルートを編集**
4. **ルートを追加**：
   - **送信先**: `0.0.0.0/0`
   - **ターゲット**: 作成したインターネットゲートウェイ
5. **変更を保存**

## 5. SSH キーファイルの設定

### ファイル配置と権限設定

```bash
# キーファイルを適切な場所に配置
mv ~/Downloads/my-ec2-key.pem ~/.ssh/

# 権限を設定
chmod 400 ~/.ssh/my-ec2-key.pem

# 確認
ls -la ~/.ssh/my-ec2-key.pem
# 結果: -r-------- 1 username username ... my-ec2-key.pem
```

## 6. 接続テスト

### ターミナルでの直接 SSH 接続テスト

```bash
# パブリックIPアドレスを実際のものに置き換えてください
ssh -i "~/.ssh/my-ec2-key.pem" ec2-user@YOUR_PUBLIC_IP -v
```

**成功すれば**:

```
Welcome to Amazon Linux 2023!
[ec2-user@ip-xxx-xxx-xxx-xxx ~]$
```

### EC2 Instance Connect での確認テスト

1. **EC2 ダッシュボード** → **インスタンス** → **接続**
2. **EC2 Instance Connect** タブ
3. **ユーザー名**: `ec2-user`
4. **接続** をクリック

## 7. VS Code の設定

### Remote-SSH 拡張機能のインストール

1. VS Code を開く
2. 拡張機能タブ（Ctrl+Shift+X）を開く
3. "Remote - SSH" を検索してインストール

### SSH 設定ファイルの作成

1. VS Code で `Cmd+Shift+P` を押してコマンドパレットを開く
2. `Remote-SSH: Open SSH Configuration File` を検索・選択
3. `~/.ssh/config` を選択
4. 以下の設定を追加：

```
Host my-ec2
    HostName YOUR_EC2_PUBLIC_IP
    User ec2-user
    IdentityFile ~/.ssh/my-ec2-key.pem
    ServerAliveInterval 60
```

## 8. VS Code でリモート接続

### 接続手順

1. VS Code で `Cmd+Shift+P`
2. `Remote-SSH: Connect to Host` を検索・選択
3. `my-ec2` を選択
4. 新しい VS Code ウィンドウが開き、EC2 に接続される
5. 左下に `SSH: my-ec2` と表示されれば成功

## 9. トラブルシューティング

### 接続できない場合の確認順序

#### ステップ 1: インスタンス状態確認

- [ ] インスタンスの状態: `running`
- [ ] ステータスチェック: `2/2 checks passed`

#### ステップ 2: ネットワーク設定確認

- [ ] インターネットゲートウェイが VPC にアタッチされている
- [ ] ルートテーブルに `0.0.0.0/0 → igw-xxxxx` のルートが存在する
- [ ] パブリック IP アドレスが割り当てられている

#### ステップ 3: セキュリティグループ確認

- [ ] SSH (Port 22) が開いている
- [ ] ソース設定が適切（マイ IP または 0.0.0.0/0）

#### ステップ 4: SSH 設定確認

- [ ] キーファイルの権限が `400`
- [ ] SSH 設定ファイルのパスが正確
- [ ] ユーザー名が `ec2-user`

### 段階的テスト方法

1. **EC2 Instance Connect**: ブラウザでの接続テスト
2. **ターミナル SSH**: `ssh -v` での詳細ログ確認
3. **VS Code Remote-SSH**: 最終的な接続テスト

## 10. 開発環境のセットアップ

EC2 に接続後、必要な開発ツールをインストール：

```bash
# システム更新
sudo dnf update -y

# 基本的な開発ツール
sudo dnf groupinstall -y "Development Tools"
sudo dnf install -y git curl wget

# Node.js（例）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install node

# Python（例）
sudo dnf install -y python3 python3-pip
```

## 11. セキュリティ設定とベストプラクティス

### セキュリティグループの最適化

1. 開発完了後、セキュリティグループのソースを `0.0.0.0/0` から **マイ IP** に変更
2. 不要なポートは開放しない

### インスタンス管理

- **停止**: 使わない時はインスタンスを停止してコスト削減
- **開始**: 停止後の開始時はパブリック IP が変わるため、SSH 設定の更新が必要
- **終了**: 不要になったら必ず終了（削除）

### キーファイル管理

- `.pem` ファイルは絶対に他人に渡さない
- バックアップを安全な場所に保管
- 複数人で作業する場合は個別のキーペアを作成

## まとめ

重要ポイント：

1. **デフォルト VPC の使用**: 初心者は必ずデフォルト VPC を選択
2. **インターネットゲートウェイの確認**: EC2 作成後、必ずネットワーク設定を確認
3. **段階的テスト**: ターミナル → Instance Connect → VS Code の順でテスト
4. **セキュリティ**: 接続確認後は適切な IP 制限を設定
